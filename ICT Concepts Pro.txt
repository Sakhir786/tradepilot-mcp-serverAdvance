//@version=6
indicator("ICT Concepts Pro", overlay=true, max_boxes_count=100, max_lines_count=100, max_labels_count=100)

// INPUTS
show_ob = input.bool(true, "Order Blocks", group="Display")
show_fvg = input.bool(true, "Fair Value Gaps", group="Display")
show_liq = input.bool(true, "Liquidity Sweeps", group="Display")
show_quality = input.bool(true, "Quality Scores", group="Display")
show_dashboard = input.bool(true, "Dashboard", group="Display")

min_quality = input.int(60, "Min Quality Score", minval=0, maxval=100, group="Filters")
ob_length = input.int(10, "OB Swing Length", minval=3, group="Filters")
max_ob = input.int(3, "Max Order Blocks", minval=1, maxval=10, group="Filters")
max_fvg = input.int(3, "Max FVGs", minval=1, maxval=10, group="Filters")
max_liq = input.int(2, "Max Liquidity Zones", minval=1, maxval=5, group="Filters")

volume_mult = input.float(1.5, "Volume Multiplier", minval=1.0, step=0.1, group="Quality")
trend_length = input.int(50, "Trend EMA", minval=10, group="Quality")

col_ob_bull = input.color(color.new(color.blue, 80), "OB Bull", group="Colors")
col_ob_bear = input.color(color.new(color.red, 80), "OB Bear", group="Colors")
col_fvg_bull = input.color(color.new(color.green, 85), "FVG Bull", group="Colors")
col_fvg_bear = input.color(color.new(color.orange, 85), "FVG Bear", group="Colors")
col_liq_buy = input.color(color.lime, "Liquidity Buy", group="Colors")
col_liq_sell = input.color(color.red, "Liquidity Sell", group="Colors")

// TYPES
type OrderBlock
    box bx
    line ln
    label lb
    float quality
    string direction
    bool active

type FVG
    box bx
    label lb
    float quality
    string direction
    bool active

type Liquidity
    line ln
    label lb
    float price
    string direction
    bool swept

var ob_bull = array.new<OrderBlock>()
var ob_bear = array.new<OrderBlock>()
var fvg_bull = array.new<FVG>()
var fvg_bear = array.new<FVG>()
var liq_buy = array.new<Liquidity>()
var liq_sell = array.new<Liquidity>()

// HELPERS
trend_ema = ta.ema(close, trend_length)
is_uptrend = close > trend_ema
avg_vol = ta.sma(volume, 20)
atr_val = ta.atr(14)

get_quality_color(q) =>
    q >= 80 ? color.green : q >= 70 ? color.lime : q >= 60 ? color.yellow : color.orange

// SWING DETECTION
ph = ta.pivothigh(high, ob_length, ob_length)
pl = ta.pivotlow(low, ob_length, ob_length)

var float last_ph = na
var float last_pl = na
var int last_ph_bar = na
var int last_pl_bar = na

if not na(ph)
    last_ph := ph
    last_ph_bar := bar_index - ob_length

if not na(pl)
    last_pl := pl
    last_pl_bar := bar_index - ob_length

// ORDER BLOCK BULLISH
if show_ob and not na(last_ph) and ta.crossover(close, last_ph)
    ob_high = high[1]
    ob_low = low[1]
    delta = 0.0
    max_vol = 0.0
    
    for i = 0 to 10
        delta += close[i] > open[i] ? volume[i] : -volume[i]
        max_vol := math.max(max_vol, volume[i])
    
    quality = 50.0
    if math.abs(delta) > 1000000
        quality += 15
    else if math.abs(delta) > 500000
        quality += 10
    
    if max_vol > avg_vol * 2.0
        quality += 15
    else if max_vol > avg_vol * volume_mult
        quality += 10
    
    if delta > 0
        quality += 10
    
    if is_uptrend
        quality += 10
    
    quality := math.min(quality, 100)
    
    if quality >= min_quality
        new_bx = box.new(bar_index, ob_high, bar_index+20, ob_low, bgcolor=col_ob_bull, border_color=color.new(color.blue, 50))
        new_ln = line.new(bar_index, math.avg(ob_high, ob_low), bar_index+20, math.avg(ob_high, ob_low), color=color.blue, width=2)
        new_lb = show_quality ? label.new(bar_index, ob_low, str.tostring(quality, format.mintick), color=get_quality_color(quality), textcolor=color.white, style=label.style_label_up, size=size.small) : label(na)
        
        ob_bull.unshift(OrderBlock.new(new_bx, new_ln, new_lb, quality, "BULL", true))
        
        if ob_bull.size() > max_ob
            old = ob_bull.pop()
            old.bx.delete()
            old.ln.delete()
            if not na(old.lb)
                old.lb.delete()

// ORDER BLOCK BEARISH
if show_ob and not na(last_pl) and ta.crossunder(close, last_pl)
    ob_high = high[1]
    ob_low = low[1]
    delta = 0.0
    max_vol = 0.0
    
    for i = 0 to 10
        delta += close[i] > open[i] ? volume[i] : -volume[i]
        max_vol := math.max(max_vol, volume[i])
    
    quality = 50.0
    if math.abs(delta) > 1000000
        quality += 15
    else if math.abs(delta) > 500000
        quality += 10
    
    if max_vol > avg_vol * 2.0
        quality += 15
    else if max_vol > avg_vol * volume_mult
        quality += 10
    
    if delta < 0
        quality += 10
    
    if not is_uptrend
        quality += 10
    
    quality := math.min(quality, 100)
    
    if quality >= min_quality
        new_bx = box.new(bar_index, ob_high, bar_index+20, ob_low, bgcolor=col_ob_bear, border_color=color.new(color.red, 50))
        new_ln = line.new(bar_index, math.avg(ob_high, ob_low), bar_index+20, math.avg(ob_high, ob_low), color=color.red, width=2)
        new_lb = show_quality ? label.new(bar_index, ob_high, str.tostring(quality, format.mintick), color=get_quality_color(quality), textcolor=color.white, style=label.style_label_down, size=size.small) : label(na)
        
        ob_bear.unshift(OrderBlock.new(new_bx, new_ln, new_lb, quality, "BEAR", true))
        
        if ob_bear.size() > max_ob
            old = ob_bear.pop()
            old.bx.delete()
            old.ln.delete()
            if not na(old.lb)
                old.lb.delete()

// FVG DETECTION
bullish_fvg = low > high[2]
bearish_fvg = high < low[2]

if show_fvg and bullish_fvg
    fvg_top = low
    fvg_btm = high[2]
    delta_vol = volume - volume[1]
    
    quality = 50.0
    if delta_vol > avg_vol * 0.5
        quality += 20
    else if delta_vol > 0
        quality += 10
    
    gap_size = fvg_top - fvg_btm
    if gap_size > atr_val * 0.3
        quality += 15
    else if gap_size > atr_val * 0.1
        quality += 10
    
    if is_uptrend
        quality += 15
    
    quality := math.min(quality, 100)
    
    if quality >= min_quality
        new_bx = box.new(bar_index-2, fvg_top, bar_index+15, fvg_btm, bgcolor=col_fvg_bull, border_color=color.new(color.green, 60))
        new_lb = show_quality ? label.new(bar_index, math.avg(fvg_top, fvg_btm), str.tostring(quality, format.mintick), color=get_quality_color(quality), textcolor=color.white, size=size.small) : label(na)
        
        fvg_bull.unshift(FVG.new(new_bx, new_lb, quality, "BULL", true))
        
        if fvg_bull.size() > max_fvg
            old = fvg_bull.pop()
            old.bx.delete()
            if not na(old.lb)
                old.lb.delete()

if show_fvg and bearish_fvg
    fvg_top = low[2]
    fvg_btm = high
    delta_vol = volume - volume[1]
    
    quality = 50.0
    if delta_vol > avg_vol * 0.5
        quality += 20
    else if delta_vol > 0
        quality += 10
    
    gap_size = fvg_top - fvg_btm
    if gap_size > atr_val * 0.3
        quality += 15
    else if gap_size > atr_val * 0.1
        quality += 10
    
    if not is_uptrend
        quality += 15
    
    quality := math.min(quality, 100)
    
    if quality >= min_quality
        new_bx = box.new(bar_index-2, fvg_top, bar_index+15, fvg_btm, bgcolor=col_fvg_bear, border_color=color.new(color.orange, 60))
        new_lb = show_quality ? label.new(bar_index, math.avg(fvg_top, fvg_btm), str.tostring(quality, format.mintick), color=get_quality_color(quality), textcolor=color.white, size=size.small) : label(na)
        
        fvg_bear.unshift(FVG.new(new_bx, new_lb, quality, "BEAR", true))
        
        if fvg_bear.size() > max_fvg
            old = fvg_bear.pop()
            old.bx.delete()
            if not na(old.lb)
                old.lb.delete()

// LIQUIDITY SWEEP BUY
if show_liq and not na(last_ph)
    if close > last_ph and volume > avg_vol * volume_mult
        new_ln = line.new(last_ph_bar, last_ph, bar_index+10, last_ph, color=col_liq_buy, width=2, style=line.style_dashed)
        new_lb = label.new(bar_index, last_ph, "LIQ", color=color.new(col_liq_buy, 80), textcolor=col_liq_buy, style=label.style_label_down, size=size.small)
        
        liq_buy.unshift(Liquidity.new(new_ln, new_lb, last_ph, "BUY", false))
        
        if liq_buy.size() > max_liq
            old = liq_buy.pop()
            old.ln.delete()
            old.lb.delete()

// LIQUIDITY SWEEP SELL
if show_liq and not na(last_pl)
    if close < last_pl and volume > avg_vol * volume_mult
        new_ln = line.new(last_pl_bar, last_pl, bar_index+10, last_pl, color=col_liq_sell, width=2, style=line.style_dashed)
        new_lb = label.new(bar_index, last_pl, "LIQ", color=color.new(col_liq_sell, 80), textcolor=col_liq_sell, style=label.style_label_up, size=size.small)
        
        liq_sell.unshift(Liquidity.new(new_ln, new_lb, last_pl, "SELL", false))
        
        if liq_sell.size() > max_liq
            old = liq_sell.pop()
            old.ln.delete()
            old.lb.delete()

// UPDATE BOXES
for ob in ob_bull
    if ob.active
        ob.bx.set_right(bar_index+20)
        ob.ln.set_x2(bar_index+20)
        if close < ob.bx.get_bottom()
            ob.active := false
            ob.bx.set_bgcolor(color.new(col_ob_bull, 95))

for ob in ob_bear
    if ob.active
        ob.bx.set_right(bar_index+20)
        ob.ln.set_x2(bar_index+20)
        if close > ob.bx.get_top()
            ob.active := false
            ob.bx.set_bgcolor(color.new(col_ob_bear, 95))

for fvg in fvg_bull
    if fvg.active
        fvg.bx.set_right(bar_index+15)
        if close < fvg.bx.get_bottom()
            fvg.active := false
            fvg.bx.set_bgcolor(color.new(col_fvg_bull, 95))

for fvg in fvg_bear
    if fvg.active
        fvg.bx.set_right(bar_index+15)
        if close > fvg.bx.get_top()
            fvg.active := false
            fvg.bx.set_bgcolor(color.new(col_fvg_bear, 95))

for liq in liq_buy
    if not liq.swept
        liq.ln.set_x2(bar_index+10)

for liq in liq_sell
    if not liq.swept
        liq.ln.set_x2(bar_index+10)

// DASHBOARD
if show_dashboard and barstate.islast
    active_ob_bull = 0
    active_ob_bear = 0
    active_fvg_bull = 0
    active_fvg_bear = 0
    avg_ob_q = 0.0
    avg_fvg_q = 0.0
    
    for ob in ob_bull
        if ob.active
            active_ob_bull += 1
            avg_ob_q += ob.quality
    
    for ob in ob_bear
        if ob.active
            active_ob_bear += 1
            avg_ob_q += ob.quality
    
    for fvg in fvg_bull
        if fvg.active
            active_fvg_bull += 1
            avg_fvg_q += fvg.quality
    
    for fvg in fvg_bear
        if fvg.active
            active_fvg_bear += 1
            avg_fvg_q += fvg.quality
    
    total_ob = active_ob_bull + active_ob_bear
    total_fvg = active_fvg_bull + active_fvg_bear
    
    if total_ob > 0
        avg_ob_q := avg_ob_q / total_ob
    if total_fvg > 0
        avg_fvg_q := avg_fvg_q / total_fvg
    
    bias = active_ob_bull > active_ob_bear ? "BULLISH" : active_ob_bear > active_ob_bull ? "BEARISH" : "NEUTRAL"
    
    var table dash = table.new(position.top_right, 1, 1)
    
    line1 = "ICT CONCEPTS"
    line2 = "Bias: " + bias
    line3 = "OB: " + str.tostring(total_ob)
    line4 = "Avg Q: " + str.tostring(avg_ob_q, format.mintick)
    line5 = "FVG: " + str.tostring(total_fvg)
    line6 = "Liq: " + str.tostring(liq_buy.size() + liq_sell.size())
    
    txt = line1 + "\n" + line2 + "\n" + line3 + "\n" + line4 + "\n" + line5 + "\n" + line6
    
    table.cell(dash, 0, 0, txt, text_color=color.white, text_size=size.small, bgcolor=color.new(color.black, 20))