â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘                     TRADEPILOT ENGINE ARCHITECTURE                           â•‘
â•‘                    Max Pain + Greeks Integration                             â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ“¦ FILE STRUCTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

tradepilot-engine/
â”‚
â”œâ”€â”€ main.py                          â† Register routers here
â”‚
â”œâ”€â”€ indicators/                      â† Core calculation engines
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ max_pain_calculator.py      âœ… NEW - Max Pain logic
â”‚   â”œâ”€â”€ options_greeks.py           âœ… NEW - Greeks analysis
â”‚   â”œâ”€â”€ gex_calculator.py           â† (Your existing GEX module)
â”‚   â”œâ”€â”€ iv_rank.py                  â† (Your existing IV module)
â”‚   â””â”€â”€ ...                         â† (Other indicators)
â”‚
â”œâ”€â”€ routers/                         â† FastAPI endpoints
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ max_pain_router.py          âœ… NEW - /max-pain/* endpoints
â”‚   â”œâ”€â”€ greeks_router.py            âœ… NEW - /greeks/* endpoints
â”‚   â”œâ”€â”€ gex_router.py               â† (Your existing GEX router)
â”‚   â””â”€â”€ ...                         â† (Other routers)
â”‚
â””â”€â”€ engines/                         â† Layer engines
    â”œâ”€â”€ layer_16_engine.py          â† Integrate Max Pain + Greeks here
    â””â”€â”€ ...


ğŸ”„ DATA FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                      POLYGON.IO API                             â”‚
   â”‚            (Real-time Options Chain Data)                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                               â”‚
                     â–¼                               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   MaxPainCalculator         â”‚   â”‚   OptionsGreeksAnalyzer      â”‚
   â”‚   (max_pain_calculator.py)  â”‚   â”‚   (options_greeks.py)        â”‚
   â”‚                             â”‚   â”‚                              â”‚
   â”‚   â€¢ Fetches options chain   â”‚   â”‚   â€¢ Fetches options chain    â”‚
   â”‚   â€¢ Gets OI for all strikes â”‚   â”‚   â€¢ Extracts Greeks          â”‚
   â”‚   â€¢ Calculates pain levels  â”‚   â”‚   â€¢ Classifies regimes       â”‚
   â”‚   â€¢ Returns max pain strike â”‚   â”‚   â€¢ ATM/Portfolio analysis   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                   â”‚
                 â–¼                                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    MaxPainRouter            â”‚   â”‚    GreeksRouter              â”‚
   â”‚    (FastAPI Endpoints)      â”‚   â”‚    (FastAPI Endpoints)       â”‚
   â”‚                             â”‚   â”‚                              â”‚
   â”‚   GET /max-pain/{symbol}    â”‚   â”‚   GET /greeks/{symbol}       â”‚
   â”‚   GET /max-pain/{symbol}/   â”‚   â”‚   POST /greeks/portfolio     â”‚
   â”‚       bias                  â”‚   â”‚   GET /greeks/{symbol}/delta â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚     Layer 16 Engine           â”‚
                 â”‚     (IV/Options Analysis)     â”‚
                 â”‚                               â”‚
                 â”‚   Combines:                   â”‚
                 â”‚   â€¢ Max Pain                  â”‚
                 â”‚   â€¢ Greeks                    â”‚
                 â”‚   â€¢ GEX                       â”‚
                 â”‚   â€¢ IV Rank                   â”‚
                 â”‚   â€¢ Options Flow              â”‚
                 â”‚                               â”‚
                 â”‚   Returns:                    â”‚
                 â”‚   â€¢ Trading signals           â”‚
                 â”‚   â€¢ Risk metrics              â”‚
                 â”‚   â€¢ Confluence scores         â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚       TradePilot Brain        â”‚
                 â”‚    (Master Decision Engine)   â”‚
                 â”‚                               â”‚
                 â”‚   â€¢ Aggregates all 25+ layers â”‚
                 â”‚   â€¢ Calculates win probabilityâ”‚
                 â”‚   â€¢ Generates trade signals   â”‚
                 â”‚   â€¢ Risk management           â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸ¯ LAYER 16 INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

from indicators.max_pain_calculator import MaxPainCalculator
from indicators.options_greeks import OptionsGreeksAnalyzer
from indicators.gex_calculator import GEXCalculator
from indicators.iv_rank import IVRankCalculator

class Layer16Engine:
    """
    Layer 16: IV and Options Analysis
    
    Prevents 40% of bad options trades by analyzing:
    - Max Pain (where market makers want price)
    - Greeks (risk metrics)
    - GEX (gamma exposure)
    - IV Rank (volatility regime)
    """
    
    def __init__(self):
        self.max_pain = MaxPainCalculator()
        self.greeks = OptionsGreeksAnalyzer()
        self.gex = GEXCalculator()
        self.iv_rank = IVRankCalculator()
    
    def analyze(self, symbol: str) -> dict:
        """
        Comprehensive options analysis
        
        Returns trading signal with confluence score
        """
        # 1. Get Max Pain
        max_pain_data = self.max_pain.calculate_max_pain(symbol)
        
        # 2. Get Greeks
        greeks_data = self.greeks.get_atm_greeks(symbol)
        
        # 3. Get GEX (from your existing module)
        gex_data = self.gex.calculate_gex(symbol)
        
        # 4. Get IV Rank
        iv_data = self.iv_rank.get_iv_metrics(symbol)
        
        # 5. Calculate Confluence
        confluence = self._calculate_confluence(
            max_pain_data,
            greeks_data,
            gex_data,
            iv_data
        )
        
        return {
            "layer": 16,
            "symbol": symbol,
            "max_pain": {
                "bias": max_pain_data["bias"],
                "signal": max_pain_data["signal"],
                "distance": max_pain_data["distance_to_max_pain"],
                "strike": max_pain_data["max_pain_strike"]
            },
            "greeks": {
                "delta": greeks_data["call_greeks"]["delta"],
                "gamma": greeks_data["call_greeks"]["gamma"],
                "theta": greeks_data["call_greeks"]["theta"],
                "vega": greeks_data["call_greeks"]["vega"]
            },
            "gex": gex_data,
            "iv": iv_data,
            "confluence_score": confluence["score"],
            "trading_signal": confluence["signal"],
            "confidence": confluence["confidence"]
        }
    
    def _calculate_confluence(self, max_pain, greeks, gex, iv) -> dict:
        """
        Calculate confluence from multiple signals
        
        Strong signals occur when:
        1. Max Pain aligns with GEX direction
        2. Greeks show favorable risk/reward
        3. IV is in optimal regime
        """
        score = 0
        max_score = 100
        
        # Max Pain + GEX Confluence (40 points)
        if max_pain["bias"] == "BULLISH" and gex["bias"] == "BULLISH":
            score += 40
        elif max_pain["bias"] == "BEARISH" and gex["bias"] == "BEARISH":
            score += 40
        elif max_pain["bias"] == "NEUTRAL":
            score += 10
        
        # Greeks Regime (30 points)
        if greeks["call_greeks"]["gamma"] > 0.03:  # High gamma
            score += 15
        if abs(greeks["call_greeks"]["theta"]) < 50:  # Low theta decay
            score += 15
        
        # IV Regime (30 points)
        if iv["iv_percentile"] < 30 and max_pain["bias"] == "BULLISH":
            score += 30  # Cheap premium + bullish = perfect
        elif iv["iv_percentile"] > 70 and max_pain["bias"] == "BEARISH":
            score += 30  # High IV + bearish = sell premium
        elif 30 <= iv["iv_percentile"] <= 70:
            score += 15  # Neutral IV
        
        # Determine Signal
        if score >= 80:
            signal = "STRONG_" + max_pain["signal"]
            confidence = "HIGH"
        elif score >= 60:
            signal = max_pain["signal"]
            confidence = "MODERATE"
        else:
            signal = "WAIT"
            confidence = "LOW"
        
        return {
            "score": score,
            "max_score": max_score,
            "signal": signal,
            "confidence": confidence
        }


ğŸ“Š API USAGE EXAMPLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Direct Module Usage (In Python)
   --------------------------------
   from indicators.max_pain_calculator import MaxPainCalculator
   
   calc = MaxPainCalculator()
   result = calc.calculate_max_pain("SPY")
   
   print(f"Max Pain: ${result['max_pain_strike']}")
   print(f"Bias: {result['bias']}")

2. FastAPI Endpoint Usage (REST API)
   ----------------------------------
   # From any client (curl, n8n, frontend, etc.)
   
   curl http://localhost:8000/max-pain/SPY
   curl http://localhost:8000/greeks/AAPL

3. Layer Engine Integration
   --------------------------
   layer16 = Layer16Engine()
   analysis = layer16.analyze("SPY")
   
   if analysis["confluence_score"] >= 80:
       execute_trade(analysis["trading_signal"])


ğŸ”— DATA DEPENDENCIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   POLYGON.IO API   â”‚  â† Single data source for all modules
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â†’ Max Pain (needs: options chain, OI, strikes)
          â”œâ”€â†’ Greeks (needs: options chain, Greeks data)
          â”œâ”€â†’ GEX (needs: options chain, OI, gamma)
          â””â”€â†’ IV Rank (needs: options prices, historical IV)

All modules use the same Polygon API key: POLYGON_API_KEY


âš¡ PERFORMANCE NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Caching Strategy
   ----------------
   â€¢ Cache options chain for 5 minutes
   â€¢ Cache Greeks for 1 minute (change rapidly)
   â€¢ Cache Max Pain for 15 minutes
   
   â†’ Reduces API calls by 80%
   â†’ Stays within Polygon rate limits

2. Parallel Fetching
   -----------------
   Use asyncio to fetch all indicators simultaneously:
   
   results = await asyncio.gather(
       max_pain.calculate_max_pain("SPY"),
       greeks.get_atm_greeks("SPY"),
       gex.calculate_gex("SPY")
   )
   
   â†’ 3x faster than sequential

3. API Rate Limits
   ---------------
   Polygon.io limits:
   â€¢ Free: 5 calls/minute
   â€¢ Starter: 100 calls/minute
   â€¢ Developer: 1000 calls/minute
   
   Recommendation: Use Starter ($29/month) for production


ğŸ¯ ROADMAP INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Week 1-2: Phase 1 - Critical Options Foundation âœ… DONE
â”œâ”€â”€ Layer 16: IV Analysis                       âœ… DONE
â”œâ”€â”€ Max Pain Calculator                         âœ… DONE (NEW!)
â””â”€â”€ Options Greeks                              âœ… DONE (NEW!)

Week 3-4: Phase 1 Continued
â”œâ”€â”€ Layer 17: Support/Resistance                â†’ NEXT
â”œâ”€â”€ Layer 18: Pivot Points                      â†’ NEXT
â””â”€â”€ Options Flow Analysis                       â†’ NEXT

Max Pain + Greeks are now part of your Layer 16 arsenal! ğŸ‰


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ready to integrate? Copy files and start testing! ğŸš€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
